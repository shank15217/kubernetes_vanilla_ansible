---
- hosts: "{{ variable_host | default('picluster') }}"
  gather_facts: no
  become: yes
  vars:
    sandbox_image_version: '3.10'

  tasks:
    - name: Set containerd settings to defaults 
      ansible.builtin.shell: /usr/bin/containerd config default > /etc/containerd/config.toml 

    - name: Enable the CRI plugin to support kubernetes
      lineinfile:
        path: /etc/containerd/config.toml
        search_string: SystemdCgroup
        line: '            SystemdCgroup = true'

    - name: Change sandbox image version to recommended version
      lineinfile:
        path: /etc/containerd/config.toml
        search_string: sandbox_image
        line: '    sandbox_image = "registry.k8s.io/pause:{{ sandbox_image_version }}"'
      register: task_result

    - name: Reboot immediately if there was a change.
      shell: "sleep 5 && reboot"
      async: 1
      poll: 0
      when: task_result is changed

    - name: Wait for the reboot to complete if there was a change.
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300
      when: task_result is changed